"""
é«˜åº¦ãªéŸ³å£°ç”Ÿæˆã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ï¼š
1. å°æœ¬ã®åˆ†å‰²ï¼ˆé•·æ–‡å¯¾å¿œï¼‰
2. ä¸¦åˆ—éŸ³å£°ç”Ÿæˆ
3. éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®çµåˆ
4. è² è·åˆ†æ•£
"""
import sys
from pathlib import Path
import asyncio

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’Pythonãƒ‘ã‚¹ã«è¿½åŠ 
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

from dotenv import load_dotenv
from config.settings import Settings
from modules.advanced_audio_generator import AdvancedAudioGenerator
from utils.logger import setup_logger

# ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿
load_dotenv()


async def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    print("\n" + "=" * 80)
    print("ğŸ¤ é«˜åº¦ãªéŸ³å£°ç”Ÿæˆãƒ†ã‚¹ãƒˆ")
    print("=" * 80 + "\n")
    
    # ãƒ­ã‚¬ãƒ¼ã‚’åˆæœŸåŒ–
    logger = setup_logger()
    
    # è¨­å®šã‚’èª­ã¿è¾¼ã¿
    settings = Settings()
    
    # AudioGeneratorã‚’åˆæœŸåŒ–
    audio_gen = AdvancedAudioGenerator(settings)
    
    # ============================================================================
    # ãƒ†ã‚¹ãƒˆ1: å°æœ¬ã®åˆ†å‰²ãƒ†ã‚¹ãƒˆ
    # ============================================================================
    print("-" * 80)
    print("ãƒ†ã‚¹ãƒˆ1: å°æœ¬ã®åˆ†å‰²ãƒ†ã‚¹ãƒˆ")
    print("-" * 80)
    
    # ãƒ†ã‚¹ãƒˆç”¨ã®å°æœ¬ï¼ˆé•·æ–‡ï¼‰
    test_script = """[Aã•ã‚“] ã“ã‚“ã«ã¡ã¯ï¼ä»Šæ—¥ã¯AIé–‹ç™ºã®æœ€æ–°ãƒˆãƒ”ãƒƒã‚¯ã«ã¤ã„ã¦ãŠè©±ã—ã—ã¾ã™ã€‚æœ€è¿‘ã€å€‹äººé–‹ç™ºè€…ãŒAIã‚’æ´»ç”¨ã—ã¦MRR10ä¸‡ãƒ‰ãƒ«ã‚’é”æˆã—ãŸã¨ã„ã†äº‹ä¾‹ãŒè©±é¡Œã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯æœ¬å½“ã«é©šãã¹ãã“ã¨ã§ã™ã­ã€‚

[Bã•ã‚“] ç¢ºã‹ã«é©šãã§ã™ã­ã€‚ã§ã‚‚ã€æœ¬å½“ã«ãã‚“ãªã“ã¨ãŒå¯èƒ½ãªã‚“ã§ã—ã‚‡ã†ã‹ï¼Ÿå…·ä½“çš„ã«ã©ã®ã‚ˆã†ãªæˆ¦ç•¥ã‚’å–ã£ãŸã®ã‹æ°—ã«ãªã‚Šã¾ã™ã€‚

[Aã•ã‚“] ãã†ãªã‚“ã§ã™ï¼å®Ÿã¯ã“ã®é–‹ç™ºè€…ã¯3ã¤ã®é‡è¦ãªæˆ¦ç•¥ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚ã¾ãšç¬¬ä¸€ã«ã€ãƒ‹ãƒƒãƒãªå¸‚å ´ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚å¤§æ‰‹ä¼æ¥­ãŒè¦‹è½ã¨ã—ã¦ã„ã‚‹ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºè€…ã«ç‰¹åŒ–ã—ãŸã‚“ã§ã™ã€‚ç¬¬äºŒã«ã€ç„¡æ–™ãƒ—ãƒ©ãƒ³ã‚’å……å®Ÿã•ã›ã¦ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚’å…ˆã«ä½œã‚Šã¾ã—ãŸã€‚ãã—ã¦ç¬¬ä¸‰ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’48æ™‚é–“ä»¥å†…ã«å®Ÿè£…ã™ã‚‹è¶…é«˜é€Ÿé–‹ç™ºã‚µã‚¤ã‚¯ãƒ«ã‚’å®Ÿç¾ã—ãŸã‚“ã§ã™ã€‚

[Bã•ã‚“] ãªã‚‹ã»ã©ã€‚ã§ã‚‚ã€48æ™‚é–“ä»¥å†…ã«å®Ÿè£…ã£ã¦ã€å“è³ªç®¡ç†ã¯å¤§ä¸ˆå¤«ãªã‚“ã§ã™ã‹ï¼Ÿãƒã‚°ãŒå¤šç™ºã—ã¾ã›ã‚“ã‹ï¼Ÿ

[Aã•ã‚“] ãã‚Œã¯è‰¯ã„æŒ‡æ‘˜ã§ã™ã­ã€‚ã‚‚ã¡ã‚ã‚“ãƒªã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã™ãŒã€ã“ã®é–‹ç™ºè€…ã¯ã€Œå®Œç’§ã‚’ç›®æŒ‡ã™ã‚ˆã‚Šã€é€Ÿãæ”¹å–„ã™ã‚‹ã€ã¨ã„ã†å“²å­¦ã‚’æŒã£ã¦ã„ã¾ã—ãŸã€‚ãƒã‚°ãŒå‡ºãŸã‚‰ã€ãã‚Œã‚‚ã¾ãŸ48æ™‚é–“ä»¥å†…ã«ä¿®æ­£ã™ã‚‹ã‚“ã§ã™ã€‚ã“ã‚ŒãŒå€‹äººé–‹ç™ºã®å¼·ã¿ãªã‚“ã§ã™ï¼æ„æ€æ±ºå®šãŒé€Ÿãã€æ‰¿èªãƒ—ãƒ­ã‚»ã‚¹ãŒãªãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®è·é›¢ãŒè¿‘ã„ã€‚

[Bã•ã‚“] ç¢ºã‹ã«ã€ãã‚Œã¯å¤§ä¼æ¥­ã«ã¯ã§ããªã„ã‚¹ãƒ”ãƒ¼ãƒ‰æ„Ÿã§ã™ã­ã€‚ã§ã‚‚ã€ãƒ“ã‚¸ãƒã‚¹ã¨ã—ã¦æœ¬å½“ã«æŒç¶šå¯èƒ½ãªã‚“ã§ã—ã‚‡ã†ã‹ï¼Ÿ

[Aã•ã‚“] ã¯ã„ï¼å®Ÿã¯æœˆé–“ã®è§£ç´„ç‡ãŒ2%ä»¥ä¸‹ãªã‚“ã§ã™ã€‚ä¸€åº¦æœ‰æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãªã£ãŸã‚‰ã€ã»ã¨ã‚“ã©ã®äººãŒä½¿ã„ç¶šã‘ã¦ãã‚Œã‚‹ã€‚ã“ã‚Œã£ã¦ã€ãƒ“ã‚¸ãƒã‚¹ã¨ã—ã¦æœ€å¼·ã®çŠ¶æ…‹ã§ã™ã‚ˆã­ã€‚æ–°è¦ç²å¾—ã ã‘ã˜ã‚ƒãªãã¦ã€æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¶­æŒã‚‚ã§ãã¦ã„ã‚‹ã€‚ä¾¡æ ¼è¨­å®šã‚‚æœˆé¡49ãƒ‰ãƒ«ã¨çµ¶å¦™ã§ã€å€‹äººã§ã‚‚æ‰‹ãŒå‡ºã›ã‚‹ç¯„å›²ãªã‚“ã§ã™ã€‚"""
    
    # å°æœ¬ã‚’åˆ†å‰²
    chunks = audio_gen.split_script_into_chunks(test_script)
    
    print(f"\nâœ… åˆ†å‰²çµæœ:")
    print(f"   å…ƒã®æ–‡å­—æ•°: {len(test_script)}æ–‡å­—")
    print(f"   åˆ†å‰²å¾Œã®ãƒãƒ£ãƒ³ã‚¯æ•°: {len(chunks)}å€‹")
    print(f"\n   å„ãƒãƒ£ãƒ³ã‚¯ã®è©³ç´°:")
    
    for i, chunk in enumerate(chunks):
        print(f"   #{i+1}: [{chunk['speaker']}ã•ã‚“] {len(chunk['text'])}æ–‡å­—")
        if len(chunk['text']) > 100:
            preview = chunk['text'][:100].replace('\n', ' ')
            print(f"       ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: {preview}...")
        else:
            print(f"       å†…å®¹: {chunk['text'][:100]}")
    
    # ============================================================================
    # ãƒ†ã‚¹ãƒˆ2: éŸ³å£°ç”Ÿæˆã®ä»•çµ„ã¿ç¢ºèª
    # ============================================================================
    print("\n" + "-" * 80)
    print("ãƒ†ã‚¹ãƒˆ2: éŸ³å£°ç”Ÿæˆã®ä»•çµ„ã¿ç¢ºèª")
    print("-" * 80)
    
    print(f"\nğŸ›ï¸ éŸ³å£°ç”Ÿæˆè¨­å®š:")
    print(f"   æœ€å¤§ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚º: {audio_gen.max_chunk_size}æ–‡å­—")
    print(f"   æœ€å¤§ä¸¦åˆ—ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: {audio_gen.max_parallel_requests}å€‹")
    print(f"   åˆ©ç”¨å¯èƒ½ãªAPIã‚­ãƒ¼: {len(audio_gen.api_keys)}å€‹")
    
    if audio_gen.api_keys:
        print(f"\n   APIã‚­ãƒ¼ã«ã‚ˆã‚‹è² è·åˆ†æ•£:")
        print(f"   - å„ãƒãƒ£ãƒ³ã‚¯ãŒç•°ãªã‚‹APIã‚­ãƒ¼ã‚’ä½¿ç”¨ï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³ï¼‰")
        print(f"   - {audio_gen.max_parallel_requests}å€‹ã®ãƒãƒ£ãƒ³ã‚¯ã‚’åŒæ™‚å‡¦ç†")
        print(f"   - ç†è«–ä¸Šã®å‡¦ç†é€Ÿåº¦: å˜ä¸€APIã®{audio_gen.max_parallel_requests}å€")
    else:
        print(f"\n   âš ï¸ APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
    
    # ============================================================================
    # ãƒ†ã‚¹ãƒˆ3: å‡¦ç†æ™‚é–“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    # ============================================================================
    print("\n" + "-" * 80)
    print("ãƒ†ã‚¹ãƒˆ3: å‡¦ç†æ™‚é–“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³")
    print("-" * 80)
    
    # 1ãƒãƒ£ãƒ³ã‚¯ã‚ãŸã‚Šã®å‡¦ç†æ™‚é–“ã‚’ä»®å®šï¼ˆç§’ï¼‰
    time_per_chunk_sequential = 10  # é€æ¬¡å‡¦ç†ã®å ´åˆ
    time_per_chunk_parallel = 10 / audio_gen.max_parallel_requests  # ä¸¦åˆ—å‡¦ç†ã®å ´åˆ
    
    total_sequential_time = len(chunks) * time_per_chunk_sequential
    total_parallel_time = len(chunks) * time_per_chunk_parallel
    
    print(f"\nâ±ï¸ å‡¦ç†æ™‚é–“ã®æ¯”è¼ƒï¼ˆæ¨å®šï¼‰:")
    print(f"   ãƒãƒ£ãƒ³ã‚¯æ•°: {len(chunks)}å€‹")
    print(f"   1ãƒãƒ£ãƒ³ã‚¯ã‚ãŸã‚Šã®å‡¦ç†æ™‚é–“: {time_per_chunk_sequential}ç§’ï¼ˆä»®å®šï¼‰")
    print(f"\n   ã€é€æ¬¡å‡¦ç†ã®å ´åˆã€‘")
    print(f"   ç·å‡¦ç†æ™‚é–“: {total_sequential_time}ç§’ ({total_sequential_time/60:.1f}åˆ†)")
    print(f"\n   ã€ä¸¦åˆ—å‡¦ç†ã®å ´åˆï¼ˆ{audio_gen.max_parallel_requests}ä¸¦åˆ—ï¼‰ã€‘")
    print(f"   ç·å‡¦ç†æ™‚é–“: {total_parallel_time}ç§’ ({total_parallel_time/60:.1f}åˆ†)")
    print(f"   æ™‚é–“çŸ­ç¸®: {total_sequential_time - total_parallel_time}ç§’ ({(1 - total_parallel_time/total_sequential_time)*100:.0f}%å‰Šæ¸›)")
    
    # ============================================================================
    # ãƒ†ã‚¹ãƒˆ4: å®Ÿéš›ã®éŸ³å£°ç”Ÿæˆï¼ˆGoogle TTSãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
    # ============================================================================
    print("\n" + "-" * 80)
    print("ãƒ†ã‚¹ãƒˆ4: å®Ÿéš›ã®éŸ³å£°ç”Ÿæˆ")
    print("-" * 80)
    
    if not audio_gen.tts_clients:
        print("\nâš ï¸ Google TTS ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆ©ç”¨ã§ãã¾ã›ã‚“")
        print("\nå¿…è¦ãªè¨­å®š:")
        print("   1. google-cloud-texttospeech ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:")
        print("      pip install google-cloud-texttospeech")
        print("   2. Google Cloudèªè¨¼æƒ…å ±ã‚’è¨­å®š:")
        print("      - assets/credentials/google-credentials.json")
        print("   3. .envãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã‚’è¿½åŠ :")
        print("      GOOGLE_CREDENTIALS_PATH=assets/credentials/google-credentials.json")
    else:
        print("\nâœ… Google TTS ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆ©ç”¨å¯èƒ½ã§ã™")
        print("\nå®Ÿéš›ã®éŸ³å£°ç”Ÿæˆã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆ:")
        print("   python run_full_pipeline.py")
    
    # ============================================================================
    # å®Œäº†
    # ============================================================================
    print("\n" + "=" * 80)
    print("âœ… é«˜åº¦ãªéŸ³å£°ç”Ÿæˆãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ")
    print("=" * 80)
    
    print("\nğŸ“‹ å®Ÿè£…ã•ã‚ŒãŸæ©Ÿèƒ½:")
    print("   âœ… å°æœ¬ã®é©åˆ‡ãªåˆ†å‰²ï¼ˆé•·æ–‡å¯¾å¿œï¼‰")
    print("   âœ… è©±è€…ã”ã¨ã®åˆ†å‰²")
    print("   âœ… ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºã®è‡ªå‹•èª¿æ•´")
    print("   âœ… è¤‡æ•°APIã‚­ãƒ¼ã«ã‚ˆã‚‹è² è·åˆ†æ•£")
    print("   âœ… ä¸¦åˆ—å‡¦ç†ï¼ˆã‚»ãƒãƒ•ã‚©ã«ã‚ˆã‚‹åˆ¶å¾¡ï¼‰")
    print("   âœ… éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•çµåˆ")
    print("   âœ… è©±è€…åˆ‡ã‚Šæ›¿ãˆæ™‚ã®è‡ªç„¶ãªé–“")
    
    print("\nğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:")
    print("   1. Google Cloud TTSã®è¨­å®š")
    print("   2. è¤‡æ•°ã®APIã‚­ãƒ¼ã‚’å–å¾—ï¼ˆè² è·åˆ†æ•£ç”¨ï¼‰")
    print("   3. Google Driveã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè£…")
    print("   4. å®Œå…¨ãªãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ")


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\n\nâš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦ä¸­æ–­ã•ã‚Œã¾ã—ãŸ")
    except Exception as e:
        print(f"\n\nâŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        import traceback
        traceback.print_exc()

