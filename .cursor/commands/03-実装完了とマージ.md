# 実装完了とマージ

## 🎯 このコマンドの目的
featureブランチの実装が完了したら、developブランチにマージする

## 📋 前提条件
- [ ] featureブランチで実装が完了している
- [ ] すべての変更がコミット済み
- [ ] テスト実行済み（オプション）
- [ ] GitHubにプッシュ済み

## 🚀 実行手順

### ステップ1: 最終確認

```bash
# 現在のブランチを確認
git branch --show-current

# すべての変更がコミット済みか確認
git status
```

**期待される出力:**
```
On branch feature/step-04-script-generation
nothing to commit, working tree clean
```

**⚠️ 未コミットの変更がある場合:**
```bash
git add .
git commit -m "feat: 最終調整"
git push origin feature/step-04-script-generation
```

---

### ステップ2: コミット履歴の確認

```bash
# このブランチのコミット履歴を確認
git log --oneline develop..HEAD

# より詳細な差分を確認
git log develop..HEAD --stat
```

**期待される出力例:**
```
abc1234 feat: run()メソッドにstep_04呼び出しを追加
def5678 feat: main.pyにstep_04_generate_script()を追加
ghi9012 feat: Claude APIで台本生成メソッドを実装
```

---

### ステップ3: developブランチを最新にする

```bash
# developブランチに切り替え
git checkout develop

# リモートから最新の変更を取得
git pull origin develop
```

**⚠️ コンフリクトが発生した場合:**
後述の「トラブルシューティング」を参照

---

### ステップ4: featureブランチをマージ

```bash
# featureブランチをdevelopにマージ
git merge --no-ff feature/step-04-script-generation

# --no-ff オプションの意味:
# マージコミットを明示的に作成（履歴がわかりやすくなる）
```

**期待される出力:**
```
Merge made by the 'recursive' strategy.
 main.py                     | XX ++
 modules/claude_client.py    | XX ++
 2 files changed, XX insertions(+)
```

**マージコミットメッセージ（自動生成）:**
```
Merge branch 'feature/step-04-script-generation' into develop
```

---

### ステップ5: マージ結果の確認

```bash
# マージ後のログを確認
git log --oneline -10 --graph

# ファイルの状態を確認
git status
```

**期待される出力:**
```
On branch develop
Your branch is ahead of 'origin/develop' by X commits.
  (use "git push" to publish your local commits)

nothing to commit, working tree clean
```

---

### ステップ6: developブランチをGitHubにプッシュ

```bash
# developブランチをリモートにプッシュ
git push origin develop
```

**期待される出力:**
```
To https://github.com/your-username/youtube-ai-podcast.git
   1234567..abcdefg  develop -> develop
```

---

### ステップ7: featureブランチの削除（ローカル）

```bash
# マージ済みのfeatureブランチをローカルから削除
git branch -d feature/step-04-script-generation
```

**期待される出力:**
```
Deleted branch feature/step-04-script-generation (was abc1234).
```

**⚠️ エラーが出た場合:**
```bash
# 強制削除（マージ済みであることを確認してから）
git branch -D feature/step-04-script-generation
```

---

### ステップ8: featureブランチの削除（リモート）

```bash
# GitHubからもfeatureブランチを削除
git push origin --delete feature/step-04-script-generation
```

**期待される出力:**
```
To https://github.com/your-username/youtube-ai-podcast.git
 - [deleted]         feature/step-04-script-generation
```

---

### ステップ9: ブランチ管理表の更新

**`ブランチ管理表.md` を更新してください:**

```markdown
| ステップ | 状態 | ブランチ | 完了日 |
|---------|------|---------|--------|
| ステップ4 | ✅ 完了 | feature/step-04-script-generation | 2024-01-15 |
```

```bash
# ブランチ管理表を更新
# エディタで .cursor/commands/ブランチ管理表.md を編集

# 変更をコミット
git add .cursor/commands/ブランチ管理表.md
git commit -m "docs: ステップ4の完了をブランチ管理表に記録"
git push origin develop
```

---

## ✅ 完了確認

```bash
# 現在のブランチ（developにいるはず）
git branch --show-current

# ローカルブランチ一覧（featureブランチが削除されているはず）
git branch

# リモートブランチ一覧
git branch -r

# 最新のコミット履歴
git log --oneline -10 --graph
```

**期待される状態:**
- ✅ developブランチにいる
- ✅ featureブランチが削除されている（ローカル・リモート共に）
- ✅ developに新しいコミットがマージされている
- ✅ GitHubのdevelopブランチが最新

---

## 🎯 次のステップ

### 次の実装を開始する場合
1. `ブランチ管理表.md` で次のステップを確認
2. `02-新しいステップの実装開始.md` を実行
3. 新しいfeatureブランチを作成

### 作業を終了する場合
1. ブランチ管理表が更新されていることを確認
2. すべての変更がGitHubにプッシュされていることを確認
3. 次回は `04-作業再開.md` から開始

---

## 🆘 トラブルシューティング

### コンフリクトが発生した場合

```bash
# コンフリクトが発生
git merge feature/step-04-script-generation

# コンフリクトファイルを確認
git status

# コンフリクトを解決
# エディタでファイルを開き、以下のマーカーを探す:
# <<<<<<< HEAD
# =======
# >>>>>>> feature/step-04-script-generation

# コンフリクトを解決したら
git add <解決したファイル>
git commit -m "fix: コンフリクトを解決"
```

**コンフリクト解決のヒント:**
1. 両方の変更を確認
2. どちらを採用するか、または両方を組み合わせるか判断
3. `<<<<<<<`, `=======`, `>>>>>>>` マーカーを削除
4. コードが正しく動作することを確認

---

### マージを取り消したい

```bash
# マージ直後であれば
git reset --hard HEAD~1

# または、マージコミットのハッシュを指定
git reset --hard abc1234
```

**⚠️ 警告:**
- `--hard` は変更を完全に破棄します
- プッシュ後の取り消しは推奨されません
- 必要に応じてバックアップを取ってください

---

### featureブランチを削除できない

```bash
# エラー: branch not fully merged
# → マージされていることを確認してから強制削除
git branch -D feature/step-04-script-generation

# リモートブランチの削除に失敗
# → ブランチ名を確認
git branch -r
git push origin --delete feature/step-04-script-generation
```

---

### プッシュが拒否された

```bash
# エラー: Updates were rejected
# → リモートに新しい変更がある

# リモートの変更を取得
git pull origin develop

# コンフリクトがなければ再度プッシュ
git push origin develop

# コンフリクトがあれば解決してからプッシュ
```

---

## 💡 ベストプラクティス

### マージのタイミング
- ✅ 1ステップ完了ごとにマージ
- ✅ 動作確認済みの状態でマージ
- ❌ 未完成の状態でマージしない
- ❌ 複数のステップをまとめてマージしない

### ブランチの削除
- ✅ マージ後すぐに削除
- ✅ ローカルとリモート両方を削除
- ❌ 使用済みブランチを残さない

### コミット履歴
- `--no-ff` オプションを使用してマージコミットを作成
- 履歴が追跡しやすくなる
- 必要に応じて revert が容易

---

## 📝 マージコミットメッセージのカスタマイズ

デフォルトのマージメッセージを変更したい場合:

```bash
# マージ時にエディタが開く
git merge --no-ff feature/step-04-script-generation

# エディタで以下のように編集:
Merge branch 'feature/step-04-script-generation' into develop

ステップ4: Claude APIで台本生成機能を実装

実装内容:
- generate_dialogue_script()メソッドの追加
- main.pyにstep_04の追加
- 対談形式の台本生成ロジック

動作確認: ✅
テスト: ✅
```

---

## 🔄 Pull Requestを使用する場合（推奨）

より厳密な管理を行う場合は、GitHubのPull Requestを使用:

### 手順:
1. featureブランチをGitHubにプッシュ
2. GitHubでPull Requestを作成
3. コードレビュー（セルフレビューも可）
4. GitHubでマージ
5. ローカルのdevelopを更新

```bash
# Pull Requestマージ後、ローカルを更新
git checkout develop
git pull origin develop

# featureブランチを削除
git branch -d feature/step-04-script-generation
```

**Pull Requestの利点:**
- コード変更が一覧できる
- レビューコメントが残る
- CIテストが自動実行される
- マージ履歴がGitHubに残る

